{% extends "base.html" %}

{% block title %}{{ 'Edit' if editing else 'Add' }} Salary - Shekel Budget App{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>{{ 'Edit' if editing else 'Add' }} Salary Information</h1>
        <p class="text-muted">
            {{ 'Update your salary information to keep your paycheck calculations accurate.' if editing else 'Add your
            salary information to calculate accurate paychecks.' }}
        </p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <form id="salaryForm" method="POST"
                        action="{{ url_for('income.manage_salary', id=request.args.get('id')) }}">
                        {{ form.csrf_token }}

                        <div class="form-section">
                            <h3>Salary Type</h3>
                            <div class="radio-group">
                                {% for subfield in form.salary_type %}
                                <div class="radio-option">
                                    {{ subfield }}
                                    {{ subfield.label }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="form-section" id="annualSalarySection">
                            <h3>Annual Salary Details</h3>
                            <div class="form-group">
                                {{ form.gross_annual_salary.label }}
                                <div class="input-with-icon">
                                    <span class="input-icon">$</span>
                                    {{ form.gross_annual_salary(class="form-control", id="grossAnnualSalary") }}
                                </div>
                                {% if form.gross_annual_salary.errors %}
                                <div class="error-message">
                                    {% for error in form.gross_annual_salary.errors %}
                                    <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-section" id="paycheckDetailsSection">
                            <h3>Paycheck Details</h3>
                            <div class="form-group">
                                {{ form.pay_frequency.label }}
                                {{ form.pay_frequency(class="form-control", id="payFrequency") }}
                                {% if form.pay_frequency.errors %}
                                <div class="error-message">
                                    {% for error in form.pay_frequency.errors %}
                                    <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-group" id="netPaycheckGroup">
                                {{ form.net_paycheck_amount.label }}
                                <div class="input-with-icon">
                                    <span class="input-icon">$</span>
                                    {{ form.net_paycheck_amount(class="form-control", id="netPaycheckAmount") }}
                                </div>
                                {% if form.net_paycheck_amount.errors %}
                                <div class="error-message">
                                    {% for error in form.net_paycheck_amount.errors %}
                                    <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-section" id="taxDeductionSection">
                            <h3>Tax & Deduction Rates</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.federal_tax_rate.label }}
                                        <div class="input-with-icon">
                                            {{ form.federal_tax_rate(class="form-control", id="federalTaxRate") }}
                                            <span class="input-icon-right">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.state_tax_rate.label }}
                                        <div class="input-with-icon">
                                            {{ form.state_tax_rate(class="form-control", id="stateTaxRate") }}
                                            <span class="input-icon-right">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.retirement_contribution_rate.label }}
                                        <div class="input-with-icon">
                                            {{ form.retirement_contribution_rate(class="form-control",
                                            id="retirementRate") }}
                                            <span class="input-icon-right">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.health_insurance_amount.label }}
                                        <div class="input-with-icon">
                                            <span class="input-icon">$</span>
                                            {{ form.health_insurance_amount(class="form-control", id="healthInsurance")
                                            }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                {{ form.other_deductions_amount.label }}
                                <div class="input-with-icon">
                                    <span class="input-icon">$</span>
                                    {{ form.other_deductions_amount(class="form-control", id="otherDeductions") }}
                                </div>
                            </div>
                        </div>

                        <div class="paycheck-calculation" id="paycheckCalculation">
                            <div class="calculation-results">
                                <h3>Calculated Per-Paycheck Breakdown</h3>
                                <table class="calculation-table">
                                    <tr>
                                        <td>Gross Pay:</td>
                                        <td id="calc-gross">$0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Federal Tax:</td>
                                        <td id="calc-federal">$0.00</td>
                                    </tr>
                                    <tr>
                                        <td>State Tax:</td>
                                        <td id="calc-state">$0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Retirement:</td>
                                        <td id="calc-retirement">$0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Health Insurance:</td>
                                        <td id="calc-health">$0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Other Deductions:</td>
                                        <td id="calc-other">$0.00</td>
                                    </tr>
                                    <tr class="calculation-total">
                                        <td>Net Pay:</td>
                                        <td id="calc-net">$0.00</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="form-section" id="depositAllocationSection">
                            <h3>Deposit Allocation Options</h3>
                            <p>Set a default deposit account or split your paycheck deposit by amount or percentage.</p>
                            <div class="deposit-allocations">
                                <div class="allocation-row">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="account_id_0">Account</label>
                                                <select id="account_id_0" name="deposit_allocations-0-account_id" class="form-control">
                                                    <option value="">-- Select Account --</option>
                                                    {% for account in accounts %}
                                                    <option value="{{ account.id }}">{{ account.account_name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Allocation Type</label>
                                                <div class="allocation-type-toggle">
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-outline-primary allocation-percentage-btn active"
                                                            data-type="percentage">Percentage</button>
                                                        <button type="button" class="btn btn-outline-primary allocation-amount-btn"
                                                            data-type="amount">Fixed Amount</button>
                                                    </div>
                                                    <input type="hidden" name="deposit_allocations-0-allocation_type" value="percentage">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group allocation-percentage-field">
                                                <label for="percentage_0">Percentage</label>
                                                <div class="input-with-icon">
                                                    <input type="number" id="percentage_0" name="deposit_allocations-0-percentage"
                                                        class="form-control" value="100" step="0.01" min="0" max="100">
                                                    <span class="input-icon-right">%</span>
                                                </div>
                                            </div>
                                            <div class="form-group allocation-amount-field" style="display:none;">
                                                <label for="amount_0">Amount</label>
                                                <div class="input-with-icon">
                                                    <span class="input-icon">$</span>
                                                    <input type="number" id="amount_0" name="deposit_allocations-0-amount" class="form-control"
                                                        step="0.01" min="0">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="allocation-divider">
                                </div>
                            </div>
                            <div class="allocation-actions">
                                <button type="button" id="add-allocation" class="btn btn-outline-primary btn-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Another Allocation
                                </button>
                            </div>
                        </div>


                        <div class="form-section">
                            <h3>Effective Dates</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {{ form.effective_date.label }}
                                        {{ form.effective_date(class="form-control", type="date") }}
                                        {% if form.effective_date.errors %}
                                        <div class="error-message">
                                            {% for error in form.effective_date.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <span {{ form.end_date.label }}  class="text-muted">(Optional)</span>
                                        {{ form.end_date(class="form-control", type="date") }}
                                        {% if form.end_date.errors %}
                                        <div class="error-message">
                                            {% for error in form.end_date.errors %}
                                            <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>Notes</h3>
                            <div class="form-group">
                                {{ form.notes(class="form-control", placeholder="Add any additional notes about this salary...") }}
                            </div>
                        </div>

                        <div class="form-options">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="generatePaychecks"
                                    name="generate_paychecks" value="1">
                                <label class="form-check-label" for="generatePaychecks">Generate paycheck schedule from
                                    this information</label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="calculateButton" class="btn btn-secondary">Calculate
                                Paycheck</button>
                            <button type="submit" class="btn btn-primary">{{ 'Update' if editing else 'Save' }} Salary
                                Information</button>
                            <a href="{{ url_for('income.overview') }}" class="btn btn-link">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card help-card">
                <div class="card-header">
                    <h3 class="card-title">Tips</h3>
                </div>
                <div class="card-body">
                    <ul class="help-list">
                        <li>
                            <strong>Annual Salary</strong>: Enter your total gross annual salary before taxes and
                            deductions.
                        </li>
                        <li>
                            <strong>Net Paycheck</strong>: If you know your net (take-home) pay amount, select this
                            option to estimate your annual salary.
                        </li>
                        <li>
                            <strong>Tax Rates</strong>: Enter percentage rates to estimate withholdings. Adjust these to
                            match your actual paychecks.
                        </li>
                        <li>
                            <strong>Effective Dates</strong>: Set when this salary becomes active. Add an end date for
                            raises or changes.
                        </li>
                    </ul>
                </div>
            </div>

            {% if salary_history %}
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Salary History</h3>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for salary in salary_history[:5] %}
                        <div class="timeline-item">
                            <div class="timeline-marker"></div>
                            <div class="timeline-content">
                                <h4>${{ "{:,.2f}".format(salary.gross_annual_salary) }}</h4>
                                <p class="timeline-date">
                                    {{ salary.effective_date.strftime('%b %d, %Y') }}
                                    {% if salary.end_date %}
                                    - {{ salary.end_date.strftime('%b %d, %Y') }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if salary_history|length > 5 %}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('income.overview') }}">View All History</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block additional_styles %}
<style>
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -0.75rem;
        margin-left: -0.75rem;
    }

    .col-md-6 {
        padding-right: 0.75rem;
        padding-left: 0.75rem;
        flex: 0 0 100%;
        max-width: 100%;
    }

    @media (min-width: 768px) {
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }

    .col-lg-8,
    .col-lg-4 {
        padding-right: 0.75rem;
        padding-left: 0.75rem;
        width: 100%;
    }

    @media (min-width: 992px) {
        .col-lg-8 {
            flex: 0 0 66.666667%;
            max-width: 66.666667%;
        }

        .col-lg-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
        }
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .card {
        background-color: var(--card-bg);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 1.5rem;
        break-inside: avoid;
    }

    .card-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background-color: rgba(0, 0, 0, 0.02);
    }

    .card-body {
        padding: 1.5rem;
    }

    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .form-section:last-child {
        border-bottom: none;
    }

    .form-section h3 {
        margin-bottom: 1.25rem;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .form-control {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: var(--text-color);
        background-color: var(--input-bg);
        background-clip: padding-box;
        border: 1px solid var(--input-border);
        border-radius: var(--border-radius);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(53, 99, 230, 0.25);
    }

    .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .radio-option {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .radio-option input {
        margin-right: 0.5rem;
    }

    .input-with-icon {
        position: relative;
    }

    .input-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }

    .input-icon-right {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }

    .input-with-icon .form-control {
        padding-left: 2rem;
    }

    .input-with-icon .input-icon-right+.form-control {
        padding-right: 2rem;
        padding-left: 0.75rem;
    }

    .error-message {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-check {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .form-check-input {
        margin-right: 0.5rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .help-card {
        background-color: var(--primary-light);
    }

    .help-list {
        padding-left: 1.5rem;
    }

    .help-list li {
        margin-bottom: 1rem;
    }

    .timeline {
        position: relative;
        padding-left: 1.5rem;
        margin-left: 0.5rem;
    }

    .timeline:before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 2px;
        background-color: var(--border-color);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .timeline-marker {
        position: absolute;
        left: -1.5rem;
        top: 0.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background-color: var(--primary-color);
        border: 2px solid var(--card-bg);
    }

    .timeline-content h4 {
        margin-bottom: 0.25rem;
        font-size: 1.1rem;
    }

    .timeline-date {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0;
    }

    .paycheck-calculation {
        background-color: var(--primary-light);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .calculation-table {
        width: 100%;
    }

    .calculation-table td {
        padding: 0.5rem;
    }

    .calculation-table td:last-child {
        text-align: right;
        font-weight: 500;
    }

    .calculation-total {
        font-weight: 700;
        border-top: 1px solid var(--border-color);
    }

    .calculation-total td {
        padding-top: 0.75rem;
    }

    /* Initially hide the net paycheck field when annual salary is selected */
    #netPaycheckGroup {
        display: none;
    }

    /* Hide calculation section initially */
    #paycheckCalculation {
        display: none;
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
            // Get references to form elements
            const salaryTypeRadios = document.getElementsByName('salary_type');
            const annualSalarySection = document.getElementById('annualSalarySection');
            const netPaycheckGroup = document.getElementById('netPaycheckGroup');
            const calculateButton = document.getElementById('calculateButton');
            const paycheckCalculation = document.getElementById('paycheckCalculation');
            const taxDeductionSection = document.getElementById('taxDeductionSection');
            const depositAllocationSection = document.getElementById('depositAllocationSection');
            const addAllocationButton = document.getElementById('add-allocation');

            // Form fields
            const grossAnnualSalary = document.getElementById('grossAnnualSalary');
            const netPaycheckAmount = document.getElementById('netPaycheckAmount');
            const payFrequency = document.getElementById('payFrequency');
            const federalTaxRate = document.getElementById('federalTaxRate');
            const stateTaxRate = document.getElementById('stateTaxRate');
            const retirementRate = document.getElementById('retirementRate');
            const healthInsurance = document.getElementById('healthInsurance');
            const otherDeductions = document.getElementById('otherDeductions');

            // Result display fields
            const calcGross = document.getElementById('calc-gross');
            const calcFederal = document.getElementById('calc-federal');
            const calcState = document.getElementById('calc-state');
            const calcRetirement = document.getElementById('calc-retirement');
            const calcHealth = document.getElementById('calc-health');
            const calcOther = document.getElementById('calc-other');
            const calcNet = document.getElementById('calc-net');

            // Function to update sections based on selected salary type
            function updateSalarySections() {
                // Find which radio is checked
                let selectedType = '';
                for (let radio of salaryTypeRadios) {
                    if (radio.checked) {
                        selectedType = radio.value;
                        break;
                    }
                }

                if (selectedType === 'annual') {
                    annualSalarySection.style.display = 'block';
                    netPaycheckGroup.style.display = 'none';
                } else if (selectedType === 'net_paycheck') {
                    annualSalarySection.style.display = 'none';
                    netPaycheckGroup.style.display = 'block';
                }

                // Hide calculation results when switching salary type
                paycheckCalculation.style.display = 'none';
            }

            // Set up event listeners for radio buttons
            for (let i = 0; i < salaryTypeRadios.length; i++) {
                salaryTypeRadios[i].addEventListener('change', updateSalarySections);
            }

            // Initialize the form state based on current radio selection
            updateSalarySections();

            // Add event listeners to tax and deduction fields to update calculation when they change
            [federalTaxRate, stateTaxRate, retirementRate, healthInsurance, otherDeductions].forEach(input => {
                if (input) {
                    input.addEventListener('input', function () {
                        // If calculation is already shown, update it automatically
                        if (paycheckCalculation.style.display === 'block') {
                            calculateButton.click();
                        }
                    });
                }
            });

            // Handle allocation type toggle buttons
            const setupAllocationToggles = () => {
                // Get all percentage and amount buttons
                const percentageButtons = document.querySelectorAll('.allocation-percentage-btn');
                const amountButtons = document.querySelectorAll('.allocation-amount-btn');

                // Set up event listeners for percentage buttons
                percentageButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        // Get the parent allocation row
                        const row = this.closest('.allocation-row');

                        // Update the hidden input value
                        const typeInput = row.querySelector('input[name$="allocation_type"]');
                        if (typeInput) typeInput.value = 'percentage';

                        // Show/hide the appropriate fields
                        const percentageField = row.querySelector('.allocation-percentage-field');
                        const amountField = row.querySelector('.allocation-amount-field');

                        if (percentageField) percentageField.style.display = 'block';
                        if (amountField) amountField.style.display = 'none';

                        // Update active state of buttons
                        this.classList.add('active');
                        const amountBtn = row.querySelector('.allocation-amount-btn');
                        if (amountBtn) amountBtn.classList.remove('active');
                    });
                });

                // Set up event listeners for amount buttons
                amountButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        // Get the parent allocation row
                        const row = this.closest('.allocation-row');

                        // Update the hidden input value
                        const typeInput = row.querySelector('input[name$="allocation_type"]');
                        if (typeInput) typeInput.value = 'amount';

                        // Show/hide the appropriate fields
                        const percentageField = row.querySelector('.allocation-percentage-field');
                        const amountField = row.querySelector('.allocation-amount-field');

                        if (percentageField) percentageField.style.display = 'none';
                        if (amountField) amountField.style.display = 'block';

                        // Update active state of buttons
                        this.classList.add('active');
                        const percentageBtn = row.querySelector('.allocation-percentage-btn');
                        if (percentageBtn) percentageBtn.classList.remove('active');
                    });
                });
            };

            // Set up initial allocation toggles
            setupAllocationToggles();

            // Function to add a new allocation row
            if (addAllocationButton) {
                addAllocationButton.addEventListener('click', function () {
                    // Get the allocation container
                    const container = document.querySelector('.deposit-allocations');
                    if (!container) return;

                    // Get the last allocation row
                    const lastRow = container.querySelector('.allocation-row:last-child');
                    if (!lastRow) return;

                    // Clone the row
                    const newRow = lastRow.cloneNode(true);

                    // Clear input values
                    newRow.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                        input.value = '';
                    });

                    // Reset the allocation type to percentage
                    const typeInput = newRow.querySelector('input[name$="allocation_type"]');
                    if (typeInput) typeInput.value = 'percentage';

                    // Show percentage field, hide amount field
                    const percentageField = newRow.querySelector('.allocation-percentage-field');
                    const amountField = newRow.querySelector('.allocation-amount-field');

                    if (percentageField) percentageField.style.display = 'block';
                    if (amountField) amountField.style.display = 'none';

                    // Reset button active states
                    const percentageBtn = newRow.querySelector('.allocation-percentage-btn');
                    const amountBtn = newRow.querySelector('.allocation-amount-btn');

                    if (percentageBtn) percentageBtn.classList.add('active');
                    if (amountBtn) amountBtn.classList.remove('active');

                    // Add a remove button if not already present
                    if (!newRow.querySelector('.remove-allocation')) {
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'allocation-actions';
                        actionsDiv.innerHTML = `
                    <button type="button" class="btn btn-outline-danger btn-sm remove-allocation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" 
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Remove
                    </button>
                `;
                        newRow.appendChild(actionsDiv);
                    }

                    // Add the new row to the container
                    container.insertBefore(newRow, container.querySelector('.allocation-actions'));

                    // Set up the toggle buttons for the new row
                    setupAllocationToggles();

                    // Set up remove button functionality
                    newRow.querySelector('.remove-allocation')?.addEventListener('click', function () {
                        newRow.remove();
                    });
                });
            }

            // Set up existing remove allocation buttons
            document.querySelectorAll('.remove-allocation').forEach(button => {
                button.addEventListener('click', function () {
                    const row = this.closest('.allocation-row');
                    if (row) row.remove();
                });
            });

            // Helper function to format currency
            function formatCurrency(value) {
                return '$' + parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            }

            // Handle calculate button click
            if (calculateButton) {
                calculateButton.addEventListener('click', function () {
                    const salaryType = document.querySelector('input[name="salary_type"]:checked').value;

                    // Validate inputs before sending API request
                    if (salaryType === 'annual' && (!grossAnnualSalary.value || parseFloat(grossAnnualSalary.value) <= 0)) {
                        alert('Please enter a valid annual salary amount.');
                        grossAnnualSalary.focus();
                        return;
                    }

                    if (salaryType === 'net_paycheck' && (!netPaycheckAmount.value || parseFloat(netPaycheckAmount.value) <= 0)) {
                        alert('Please enter a valid net paycheck amount.');
                        netPaycheckAmount.focus();
                        return;
                    }

                    // Create the payload object with common fields
                    const payload = {
                        salary_type: salaryType,
                        pay_frequency: payFrequency.value,
                        federal_tax_rate: parseFloat(federalTaxRate.value) || 0,
                        state_tax_rate: parseFloat(stateTaxRate.value) || 0,
                        retirement_contribution_rate: parseFloat(retirementRate.value) || 0,
                        health_insurance_amount: parseFloat(healthInsurance.value) || 0,
                        other_deductions_amount: parseFloat(otherDeductions.value) || 0
                    };

                    // Add salary-type specific values
                    if (salaryType === 'annual') {
                        payload.gross_annual_salary = parseFloat(grossAnnualSalary.value) || 0;
                    } else {
                        payload.net_paycheck_amount = parseFloat(netPaycheckAmount.value) || 0;
                    }

                    // Show loading state
                    calculateButton.disabled = true;
                    calculateButton.textContent = 'Calculating...';

                    // Call the API to calculate paycheck
                    fetch('/income/calculate-paycheck', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(response => response.json())
                        .then(data => {
                            // Update the calculation result fields
                            calcGross.textContent = formatCurrency(data.gross_salary);
                            calcFederal.textContent = formatCurrency(data.federal_tax);
                            calcState.textContent = formatCurrency(data.state_tax);
                            calcRetirement.textContent = formatCurrency(data.retirement);
                            calcHealth.textContent = formatCurrency(data.health_insurance);
                            calcOther.textContent = formatCurrency(data.other_deductions);
                            calcNet.textContent = formatCurrency(data.net_pay);

                            // If we calculated from net paycheck, update the estimated annual salary
                            if (salaryType === 'net_paycheck' && data.estimated_annual) {
                                grossAnnualSalary.value = data.estimated_annual;
                            }

                            // Show the calculation section
                            paycheckCalculation.style.display = 'block';

                            // Reset button state
                            calculateButton.disabled = false;
                            calculateButton.textContent = 'Calculate Paycheck';
                        })
                        .catch(error => {
                            console.error('Error calculating paycheck:', error);
                            alert('Error calculating paycheck. Please check your inputs and try again.');

                            // Reset button state
                            calculateButton.disabled = false;
                            calculateButton.textContent = 'Calculate Paycheck';
                        });
                });
            }
        });
</script>
{% endblock %}